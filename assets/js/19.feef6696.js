(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{560:function(t,a,s){"use strict";s.r(a);var e=s(6),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"文件夹结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文件夹结构"}},[t._v("#")]),t._v(" 文件夹结构")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("/hw/ 负责仿真虚拟机上所有的虚拟硬件\n/target-xyz/ QEMU能仿真的处理器架构\n/tcg/ 负责将TCG op翻译成目标代码\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("h2",{attrs:{id:"主要代码文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主要代码文件"}},[t._v("#")]),t._v(" 主要代码文件")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("/target-xyz/translate.c: 负责guest binary -> TCG op的转换\n/tcg/tcg.c: TCG主要代码\n/tcg/*/tcg-target.c: 负责TCG op -> host binary的转换\n/cpu-exec.c: 其中的 cpu-exec() 函数负责寻找下一个TB，如果没找到则进行翻译。最后执行翻译得到的host binary\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h2",{attrs:{id:"重要结构体"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重要结构体"}},[t._v("#")]),t._v(" 重要结构体")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CPUArchState")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("存在于 "),s("code",[t._v("{/target/xyz/cpu.h}")]),t._v(" "),s("code",[t._v("struct CPUArchState")]),t._v(" 是结构相关的，通过"),s("code",[t._v("typedef")]),t._v("定义"),s("code",[t._v("CPUX86State")]),t._v("，存放处理器状态")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ArchCPU")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("存在于 "),s("code",[t._v("{/target/xyz/cpu.h}")]),t._v(" "),s("code",[t._v("struct ArchCPU")]),t._v(" 是结构相关的，通过"),s("code",[t._v("typedef")]),t._v("定义"),s("code",[t._v("X86CPU")]),t._v("\n其中包含 "),s("code",[t._v("CPUState")]),t._v(" 以及 "),s("code",[t._v("CPUArchState")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CPUState")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("CPU现在状态\n"),s("code",[t._v("env_ptr")]),t._v(" 指向  "),s("code",[t._v("CPUArchState")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CPUClass")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("存在于 "),s("code",[t._v("{\\include\\hw\\core\\cpu.h}")]),t._v("\n里面包含了CPU的类型信息，同时可以说是CPU类的一个封装，类似于父类\n内部函数通过回调的方式完成“重载”")]),t._v(" "),s("h2",{attrs:{id:"用户模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用户模式"}},[t._v("#")]),t._v(" 用户模式")]),t._v(" "),s("h3",{attrs:{id:"_1-main"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-main"}},[t._v("#")]),t._v(" 1. "),s("code",[t._v("main(...)")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("linux-user/main.c")]),t._v("\n其中含有 "),s("code",[t._v("cpu_loop()")]),t._v("/"),s("code",[t._v("tcg_prologue_init()")]),t._v(" / "),s("code",[t._v("tcg_region_init()")]),t._v(" / "),s("code",[t._v("get_elf_eflags()")]),t._v("\n在完成相关环境配置后执行 "),s("code",[t._v("cpu_loop()")])]),t._v(" "),s("h3",{attrs:{id:"_2-cpu-loop-cpuarchstate-env"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-cpu-loop-cpuarchstate-env"}},[t._v("#")]),t._v(" 2. "),s("code",[t._v("cpu_loop(CPUArchState *env)")])]),t._v(" "),s("p",[t._v("定义位于 "),s("code",[t._v("linux-user/qemu.h")]),t._v("，"),s("code",[t._v('#include "cpu.h"')]),t._v(" 根据条件，在 "),s("code",[t._v("target/xyz")]),t._v(" 找\n声明位于 "),s("code",[t._v("linux-user/xyz/cpu-loop.c")]),t._v("\n内部大致处理如下：")]),t._v(" "),s("ol",[s("li",[t._v("获取CPU状态 -- "),s("code",[t._v("env_cpu()")])]),t._v(" "),s("li",[t._v("执行代码 -- "),s("code",[t._v("cpu_exec()")])]),t._v(" "),s("li",[t._v("跳出 "),s("code",[t._v("cpu_exec()")]),t._v("，说明需要处理异常")]),t._v(" "),s("li",[t._v("判断是否有异常等 -- "),s("code",[t._v("switch(trapnr)")])]),t._v(" "),s("li",[t._v("执行异常")])]),t._v(" "),s("h3",{attrs:{id:"_3-env-cpu-cpuarchstate-env"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-env-cpu-cpuarchstate-env"}},[t._v("#")]),t._v(" 3. "),s("code",[t._v("env_cpu(CPUArchState *env)")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("include/exec/cpu-all.h")])]),t._v(" "),s("h3",{attrs:{id:"_4-cpu-exec-cpustate-cpu"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-cpu-exec-cpustate-cpu"}},[t._v("#")]),t._v(" 4. "),s("code",[t._v("cpu_exec(CPUState *cpu)")])]),t._v(" "),s("p",[t._v("定义位于"),s("code",[t._v("include/exec/cpu-all.h")]),t._v("\n声明位于"),s("code",[t._v("accel/tcg/cpu-exec.c")]),t._v("\n属于整个翻译器的"),s("code",[t._v("main execution loop")])]),t._v(" "),s("ol",[s("li",[s("code",[t._v("sigsetjmp()")]),t._v(" 保存现场寄存器，方便后续跳回（使用  "),s("code",[t._v("siglongjmp()")]),t._v("）")]),t._v(" "),s("li",[s("code",[t._v("cpu_handle_exception()")]),t._v(" 处理异常")]),t._v(" "),s("li",[s("code",[t._v("cpu_handle_interrupt()")]),t._v(" 处理中断")]),t._v(" "),s("li",[s("code",[t._v("tb_find()")]),t._v(" 查找下一个TB")]),t._v(" "),s("li",[s("code",[t._v("cpu_loop_exec_tb()")]),t._v(" 执行TB")])]),t._v(" "),s("h3",{attrs:{id:"_5-tb-find"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-tb-find"}},[t._v("#")]),t._v(" 5. "),s("code",[t._v("tb_find()")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("accel/tcg/cpu-exec.c")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("inline")]),t._v(" TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tb_find")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CPUState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                        TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("last_tb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" tb_exit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" cf_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("ol",[s("li",[s("code",[t._v("tb_lookup__cpu_state()")]),t._v(" 通过 "),s("code",[t._v("CPUState")]),t._v("等，完成对于TB的获取")]),t._v(" "),s("li",[s("code",[t._v("if(未找到) tb_gen_code()")]),t._v("，同时将翻译完成的加入"),s("code",[t._v("cpu->tb_jmp_cache")]),t._v("中")]),t._v(" "),s("li",[t._v("如果有上一个TB，将这个TB链接到他的后面 -- "),s("code",[t._v("tb_add_jump()")])])]),t._v(" "),s("h3",{attrs:{id:"_6-cpu-loop-exec-tb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-cpu-loop-exec-tb"}},[t._v("#")]),t._v(" 6. "),s("code",[t._v("cpu_loop_exec_tb()")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("accel/tcg/cpu-exec.c")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("inline")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cpu_loop_exec_tb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CPUState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n                                    TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                    TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("last_tb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tb_exit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[s("code",[t._v("cpu_tb_exec()")]),t._v(" 执行一个TB")]),t._v(" "),s("h3",{attrs:{id:"_7-tb-lookup-cpu-state"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-tb-lookup-cpu-state"}},[t._v("#")]),t._v(" 7. "),s("code",[t._v("tb_lookup__cpu_state()")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("accel/tcg/cpu-exec.c")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("inline")]),t._v(" TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("\n\t\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tb_lookup__cpu_state")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CPUState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n\t\t\t\t\t\t\t\t\t\t\ttarget_ulong "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" target_ulong "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cs_base"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                         \t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" cf_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("ol",[s("li",[t._v("获取CPU状态 -- "),s("code",[t._v("cpu_get_tb_cpu_state()")])]),t._v(" "),s("li",[t._v("获取TB的hash -- "),s("code",[t._v("tb_jmp_cache_hash_func()")])]),t._v(" "),s("li",[t._v("从 "),s("code",[t._v("cpu->tb_jmp_cache")]),t._v(" 获取TB，如果获取到，并且判断正确（因为可能产生hash冲突），则返回tb")]),t._v(" "),s("li",[t._v("如果第3步没有有效的TB，去cache里面找 -- "),s("code",[t._v("tb_htable_lookup()")]),t._v("，并且放入 "),s("code",[t._v("cpu->tb_jmp_cache")])])]),t._v(" "),s("h3",{attrs:{id:"_8-tb-gen-code"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-tb-gen-code"}},[t._v("#")]),t._v(" 8. "),s("code",[t._v("tb_gen_code()")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("accel/tcg/translate-all.c")])]),t._v(" "),s("div",{staticClass:"language-C line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[t._v("TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tb_gen_code")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CPUState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                              target_ulong pc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" target_ulong cs_base"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                              "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" cflags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("ol",[s("li",[t._v("分配TB空间 -- "),s("code",[t._v("tcg_tb_alloc(tcg_ctx)")])]),t._v(" "),s("li",[t._v("翻译成中间代码 -- "),s("code",[t._v("gen_intermediate_code()")])]),t._v(" "),s("li",[t._v("翻译成宿主代码 -- "),s("code",[t._v("tcg_gen_code()")])]),t._v(" "),s("li",[t._v("将TB加入到缓存中 -- "),s("code",[t._v("tb_link_page()")])])]),t._v(" "),s("h3",{attrs:{id:"_9-cpu-tb-exec"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-cpu-tb-exec"}},[t._v("#")]),t._v(" 9. "),s("code",[t._v("cpu_tb_exec()")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("accel/tcg/cpu-exec.c")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("inline")]),t._v(" tcg_target_ulong "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cpu_tb_exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CPUState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("itb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ol",[s("li",[s("p",[t._v("执行TC --  "),s("code",[t._v("tcg_qemu_tb_exec()")]),t._v("，通过 "),s("code",[t._v("tb->tc.ptr")]),t._v(" 获得TC的地址")])]),t._v(" "),s("li",[s("p",[t._v("根据 "),s("code",[t._v("ret")]),t._v(" 进行相应操作")])])]),t._v(" "),s("h3",{attrs:{id:"_10-tcg-qemu-tb-exec"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10-tcg-qemu-tb-exec"}},[t._v("#")]),t._v(" 10. "),s("code",[t._v("tcg_qemu_tb_exec()")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("tcg_qemu_tb_exec")]),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tb_ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uintptr_t")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("tcg_ctx"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("code_gen_prologue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tb_ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("定位到 "),s("code",[t._v("code_gen_prologue()")]),t._v("，使用 "),s("code",[t._v("tcg_prologue_init(tcg_ctx) -> tcg_target_qemu_prologue(s)")]),t._v(" 完成初始化")]),t._v(" "),s("blockquote",[s("p",[t._v("位于 "),s("code",[t._v("tcg.c")])]),t._v(" "),s("p",[s("code",[t._v("size_t code_gen_buffer_size")])]),t._v(" "),s("p",[s("code",[t._v("void *code_gen_buffer")])]),t._v(" "),s("p",[s("code",[t._v("void *code_gen_prologue")])]),t._v(" "),s("p",[s("code",[t._v("void *code_gen_epilogue")])]),t._v(" "),s("p",[s("code",[t._v("void *code_gen_ptr")])]),t._v(" "),s("p",[s("code",[t._v("void *data_gen_ptr")])]),t._v(" "),s("p",[s("code",[t._v("tcg_insn_unit *code_ptr")])])]),t._v(" "),s("h3",{attrs:{id:"_11-tcg-tb-alloc-tcg-ctx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_11-tcg-tb-alloc-tcg-ctx"}},[t._v("#")]),t._v(" 11. "),s("code",[t._v("tcg_tb_alloc(tcg_ctx)")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("tcg/tcg.c")])]),t._v(" "),s("p",[t._v("负责在 "),s("code",[t._v("code_gen_buf")]),t._v(" 里面分配TB空间")]),t._v(" "),s("h3",{attrs:{id:"_12-gen-intermediate-code"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_12-gen-intermediate-code"}},[t._v("#")]),t._v(" 12. "),s("code",[t._v("gen_intermediate_code()")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("target/Arch/translate.c")])]),t._v(" "),s("ol",[s("li",[t._v("创建上下文结构 "),s("code",[t._v("DisasContext")])]),t._v(" "),s("li",[t._v("调用 "),s("code",[t._v("translator_loop()")]),t._v("进行一个块的中间代码翻译")])]),t._v(" "),s("h3",{attrs:{id:"_13-tcg-gen-code"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_13-tcg-gen-code"}},[t._v("#")]),t._v(" 13. "),s("code",[t._v("tcg_gen_code()")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("tcg/tcg.c")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tcg_gen_code")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TCGContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("blockquote",[s("p",[t._v("这里还需要进一步查看")])]),t._v(" "),s("h3",{attrs:{id:"_14-translator-loop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_14-translator-loop"}},[t._v("#")]),t._v(" 14. "),s("code",[t._v("translator_loop()")])]),t._v(" "),s("p",[t._v("位于 "),s("code",[t._v("accel/tcg/translator.c")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("translator_loop")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TranslatorOps "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ops"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DisasContextBase "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    \t\t\t\t CPUState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TranslationBlock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" max_insns"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("其中，"),s("code",[t._v("TranslatorOps")]),t._v(" 为翻译函数结构体，结构相关，内部为回调函数")]),t._v(" "),s("ol",[s("li",[s("p",[s("code",[t._v("gen_tb_start()")]),t._v(" // TODO: what this mean?")])]),t._v(" "),s("li",[s("p",[t._v("执行翻译 -- "),s("code",[t._v("ops->translate_insn();")])])]),t._v(" "),s("li",[s("p",[t._v("处理TB块满"),s("code",[t._v("(DISAS_TOO_MANY)")]),t._v("结束问题 -- "),s("code",[t._v("ops->tb_stop();")])])]),t._v(" "),s("li",[s("p",[t._v("结束TB的翻译 -- "),s("code",[t._v("gen_tb_end();")])]),t._v(" "),s("ol",[s("li",[t._v("设置TB标签 -- "),s("code",[t._v("gen_set_label()")])]),t._v(" "),s("li",[t._v("设置TB退出代码 -- "),s("code",[t._v("tcg_gen_exit_tb()")])])]),t._v(" "),s("blockquote",[s("p",[t._v("此处还要研究")])])])]),t._v(" "),s("h2",{attrs:{id:"系统模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#系统模式"}},[t._v("#")]),t._v(" 系统模式")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 存在于{/vl.c}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在完成相关环境配置后执行main_loop()")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 函数会在前序的define中被替换成qemu_main()")]),t._v("\n    \n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main_loop")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 存在于{/vl.c}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 开始会判断main_loop_should_exit()，如果没有退出的条件，就执行循环。循环内执行main_loop_wait()和 profile_getclock()。")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);